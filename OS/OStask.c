/*****************************************************************
* Copyright (C) 2017 60Plus Technology Co.,Ltd.*
******************************************************************
* osTask.c
*
* DESCRIPTION:
*     Freerots task
* AUTHOR:
*     Ziming
* CREATED DATE:
*     2018/11/27
* REVISION:
*     v0.1
*
* MODIFICATION HISTORY
* --------------------
* $Log:$
*
*****************************************************************/
/*************************************************************************************************************************
 *                                                       INCLUDES                                                        *
 *************************************************************************************************************************/
#include "loraConfig.h"
#include "iwdg.h"
#include "rtc.h"
#include "gpio.h"
#include "Network.h"
#include "lora.h"
#include "OS_timers.h"
#include "OStask.h"
/*************************************************************************************************************************
 *                                                        MACROS                                                         *
 *************************************************************************************************************************/

/*************************************************************************************************************************
 *                                                      CONSTANTS                                                        *
 *************************************************************************************************************************/

/*************************************************************************************************************************
 *                                                       TYPEDEFS                                                        *
 *************************************************************************************************************************/

/*************************************************************************************************************************
 *                                                   GLOBAL VARIABLES                                                    *
 *************************************************************************************************************************/

/*************************************************************************************************************************
 *                                                  EXTERNAL VARIABLES                                                   *
 *************************************************************************************************************************/

/*************************************************************************************************************************
 *                                                    LOCAL VARIABLES                                                    *
 *************************************************************************************************************************/

/*************************************************************************************************************************
 *                                                 FUNCTION DECLARATIONS                                                 *
 *************************************************************************************************************************/

/*************************************************************************************************************************
 *                                                   PUBLIC FUNCTIONS                                                    *
 *************************************************************************************************************************/

/*************************************************************************************************************************
 *                                                    LOCAL FUNCTIONS                                                    *
 *************************************************************************************************************************/

/*****************************************************************
* DESCRIPTION: halDriverInit
*     
* INPUTS:
*     
* OUTPUTS:
*     
* NOTE:
*     null
*****************************************************************/
void halDriverInit( void )
{
    /* Power off rtc if the device is not low power device */
#ifndef SYSTEM_LOW_POWER_STOP
    HAL_RTC_MspDeInit(&hrtc);
#else
    /* Disable the write protection for RTC registers */
    __HAL_RTC_WRITEPROTECTION_DISABLE(&hrtc);
    __HAL_RTC_ALARMA_DISABLE(&hrtc);
    __HAL_RTC_ALARM_DISABLE_IT(&hrtc, RTC_FLAG_ALRAF);
    /* Enable the write protection for RTC registers */
    __HAL_RTC_WRITEPROTECTION_ENABLE(&hrtc);
#endif
    /* Power off led */
    //SET_GPIO_PIN_LOW(LED_GPIO_Port, LED_Pin);
}


/*****************************************************************
* DESCRIPTION: osTaskInit
*     
* INPUTS:
*     
* OUTPUTS:
*     
* NOTE:
*     null
*****************************************************************/
void osTaskInit( void )
{
    taskENTER_CRITICAL();           //Enter the critical area
    /* Create lora task */
    xTaskCreate( loraProcess, "loraProcess", LORA_TASK_DEPTH, NULL, LORA_TASK_PRIORITY, &loraTaskHandle );
    /* Create network task */
    xTaskCreate( networkProcess, "networkProcess", NETWORK_TASK_DEPTH, NULL, NETWORK_TASK_PRIORITY, &networkTaskHandle );
    /* Create timer task */
    xTaskCreate( osTimerProcess, "osTimerProcess", TIMER_TASK_DEPTH, NULL, TIMER_TASK_PRIORITY, &timerTaskHandle );
    /* Create timer queue */
    timerQueueHandle = xQueueCreate( TIMER_QUEUE_LENGTH, TIMER_QUEUE_SIZE );
    /* Create feed wwdg timer */
    startReloadTimer( SYSTEM_FEED_DOG_EVENT, FEED_DOG_TIME, systemFeedDog );
    taskEXIT_CRITICAL();            //Exit the critical area
}     




/****************************************************** END OF FILE ******************************************************/
